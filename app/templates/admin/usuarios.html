{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Administración de usuarios</h2>
    </div>

    <!-- Modal para mostrar la nueva contraseña -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="passwordModalLabel">Nueva contraseña generada</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <p>La contraseña se muestra solo una vez. Asegúrate de copiarla antes de cerrar.</p>
                        </div>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="newPassword" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyPassword()">
                                <i class="fas fa-copy"></i> Copiar
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Nombre</th>
                <th>Estado</th>
                <th>Admin</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr>
                <td>{{ usuario[1] }}</td>  <!-- username -->
                <td>{{ usuario[2] }}</td>  <!-- nombre -->
                <td>{{ "Activo" if usuario[4] else "Inactivo" }}</td>
                <td>{{ "Sí" if usuario[3] else "No" }}</td>
                <td>
                    {% if usuario[0] != current_user.id %}
                        <form action="{{ url_for('admin.reset_user_password', id_usuario=usuario[0]) }}" 
                            method="POST" class="d-inline" id="resetForm{{ usuario[0] }}">
                            <button type="button" class="btn btn-warning btn-sm" 
                                    data-user-id="{{ usuario[0] }}"
                                    data-username="{{ usuario[1] }}"
                                    onclick="confirmPasswordReset(this)">
                                Resetear contraseña
                            </button>
                        </form>
                        
                        <form action="{{ url_for('admin.toggle_admin_status', id_usuario=usuario[0]) }}" 
                              method="POST" class="d-inline">
                            <button type="submit" class="btn btn-info btn-sm">
                                {{ "Quitar Admin" if usuario[3] else "Hacer admin" }}
                            </button>
                        </form>
                        
                        <form action="{{ url_for('admin.toggle_user_status', id_usuario=usuario[0]) }}" 
                              method="POST" class="d-inline">
                            <button type="submit" class="btn btn-danger btn-sm">
                                {{ "Desactivar" if usuario[4] else "Activar" }}
                            </button>
                        </form>
                    {% else %}
                        <em>Usuario actual</em>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script>
function confirmPasswordReset(button) {
    const userId = button.getAttribute('data-user-id');
    const username = button.getAttribute('data-username');
    
    if (confirm(`¿Estás seguro de que deseas resetear la contraseña del usuario ${username}?`)) {
        const form = document.getElementById(`resetForm${userId}`);
        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('newPassword').value = data.password;
                new bootstrap.Modal(document.getElementById('passwordModal')).show();
            } else {
                alert('Error al resetear la contraseña');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al resetear la contraseña');
        });
    }
}

function copyPassword() {
    const passwordInput = document.getElementById('newPassword');
    passwordInput.select();
    document.execCommand('copy');
    
    // Muestra una notificación de copiado
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copiado';
    setTimeout(() => {
        button.innerHTML = originalText;
    }, 2000);
}
</script>
{% endblock %}